= RH-PAM 7 -> Kogito Migration Journal

== Purpose
Purpose of this document is to maintain a history of the migration effort of ER-Demo's _process-service_ from RH-PAM 7 (embedded in SpringBoot) to Kogito.

== Summary

. Accessibility of process variables
+
Kogito provides direct reference to process variables from process tasks and conditionals.
For example, instead of the following used in a BPMN2 for RH-PAM 7 :
+
-----
<![CDATA[Boolean _isAvailable = (Boolean)kcontext.getVariable("responderIsAvailable");
return (_isAvailable);]]>
-----
+
the following can instead be written with a BPMN2 that runs in Kogito:
+
-----
return responderIsAvailable;
-----

. Process Id needs to facilitate auto-generation of Java class files
+
Kogito auto-generates Java class files from the _processId_ of a BPMN2.
Subsequently, the processId needs to be of a simple String convention with no special characters.

. SmallRyeReactiveMessagingLifecycle (used in Kogito) does not allow app to both consume and produce messages to the same Kafka topic (ie: *topic-incident-event*).
... [red]#Recommendation:  Detail this restriction in Kogito docs#.
... [red]#Recommendation:  In ER-Demo, create additional outgoing topic called:  *topic-incident-assignment-event*#


== Journal Details

. *21 October 2020*

.. Specifying multiple inbound and outgoing messaging channels in application.properties for each topic has resolved issues thrown by smallrye.


. *19 October 2020*

.. Two BPMN2 definitions in same project with same processId.  [red]#kogito compiler does not identify this conflict upfront.  Downstream consequences occur#
... Fixed by link:https://issues.redhat.com/browse/KOGITO-3681[KOGITO-3681]

.. SmallRyeReactiveMessagingLifecycle does not allow app to both consume and produce messages to the same Kafka topic (ie: *topic-incident-event*).
... The following is thrown when executing com.redhat.cajun.navy.process.IncidentProcessTest
+
-----
Caused by: javax.enterprise.inject.spi.DeploymentException: SRMSG00073: Invalid configuration, the following channel names cannot be used for both incoming and outgoing: [topic-incident-event]
	at io.smallrye.reactive.messaging.impl.ConfiguredChannelFactory.detectNameConflict(ConfiguredChannelFactory.java:144)
	at io.smallrye.reactive.messaging.impl.ConfiguredChannelFactory.initialize(ConfiguredChannelFactory.java:125)
	at io.smallrye.reactive.messaging.impl.ConfiguredChannelFactory_ClientProxy.initialize(ConfiguredChannelFactory_ClientProxy.zig:265)
	at java.base/java.util.Iterator.forEachRemaining(Iterator.java:133)
	at java.base/java.util.Spliterators$IteratorSpliterator.forEachRemaining(Spliterators.java:1801)
	at java.base/java.util.stream.ReferencePipeline$Head.forEach(ReferencePipeline.java:658)
	at io.smallrye.reactive.messaging.extension.MediatorManager.initializeAndRun(MediatorManager.java:161)
	at io.smallrye.reactive.messaging.extension.MediatorManager_ClientProxy.initializeAndRun(MediatorManager_ClientProxy.zig:325)
	at io.quarkus.smallrye.reactivemessaging.runtime.SmallRyeReactiveMessagingLifecycle.onApplicationStart(SmallRyeReactiveMessagingLifecycle.java:20)
-----
... [red]#Recommendation:  Detail this restriction in Kogito docs#.
... [red]#Recommendation:  In ER-Demo, create additional outgoing topic called:  *topic-incident-assignment-event*#

.. SmallRye doesn't allow multiple consumers on same Kafka topic:
+
-----
Oct 19, 2020 1:41:09 PM io.smallrye.reactive.messaging.kafka.impl.KafkaSource lambda$new$13
ERROR: SRMSG18217: Unable to read a record from Kafka topics '[topic-mission-event]'
java.lang.IllegalStateException: This processor allows only a single Subscriber
	at io.smallrye.mutiny.vertx.MultiReadStream.subscribe(MultiReadStream.java:62)
	at io.smallrye.mutiny.operators.AbstractMulti.subscribe(AbstractMulti.java:23)
	at io.smallrye.mutiny.groups.MultiSubscribe.withSubscriber(MultiSubscribe.java:68)
	at io.smallrye.mutiny.operators.multi.MultiSignalConsumerOp.subscribe(MultiSignalConsumerOp.java:50)
-----

. *25 September 2020*
.. IncidentProcessTest
+
Added first draft of this class by copying and pruning:  _org.acme.travel.MessagingIT.java_
.. Add the following dependency in project pom:
+
-----
    <dependency>
      <groupId>org.kie.kogito</groupId>
      <artifactId>kogito-test-utils</artifactId>
      <scope>test</scope>
    </dependency>
-----

.. [red]#Unable to run junit test do to _test-containers_ dependency on docker#
+
-----
ERROR: ping failed with configuration Environment variables, system properties and defaults. Resolved dockerHost=unix:///var/run/docker.sock due to org.rnorth.ducttape.TimeoutException: Timeout waiting for result with exception
org.rnorth.ducttape.TimeoutException: Timeout waiting for result with exception
	at org.rnorth.ducttape.unreliables.Unreliables.retryUntilSuccess(Unreliables.java:54)
	at org.testcontainers.dockerclient.DockerClientProviderStrategy.ping(DockerClientProviderStrategy.java:182)
	at org.testcontainers.dockerclient.EnvironmentAndSystemPropertyClientProviderStrategy.test(EnvironmentAndSystemPropertyClientProviderStrategy.java:41)
-----

... In my dev environment, I only use podman, buildah and skopeo
... Need to research progress using _test-containers_ suite and podman

.... https://github.com/testcontainers/testcontainers-java/issues/2088
.... https://lists.podman.io/archives/list/podman@lists.podman.io/thread/5K6ZOTYDISZEXCHWJJD3RFNKM33NHEDI/

. *24 September 2020*

.. Modified _incident-process_ as follows:
+
image::images/sept_24_2020.png[]

.. Upgrade to kogito 0.15.0 (which also bumped quarkus to: 1.8.0 )

.. Temporarily stub RESTful service tasks in _incident-process_ BPMN2 until a (Fuse / Camel based) ServiceTask capability is available in Kogito
+
Use the following as examples:

*** https://github.com/kiegroup/kogito-examples/tree/stable/kogito-travel-agency/basic#business-logic
*** https://github.com/kiegroup/kogito-examples/blob/stable/kogito-travel-agency/basic/src/main/java/org/acme/travels/service/FlightBookingService.java

.. [red]#Kogito docs currently not helpful with creating custom Service Tasks#
.. [red]#Kogito docs currently not helpful with updating the process definition to reference new Service Tasks#


.. Business Rule Task
... RH-PAM implemention of Incident Process implements link:https://github.com/Emergency-Response-Demo/process-service/blob/master/src/main/java/com/redhat/cajun/navy/process/wih/BusinessRuleTaskHandlerWrapper.java[a custom WIH] to execute business rules.
.... This is a wrapper around the OOTB BusinessRuleTask.
.... Rules are loaded as per GAV
.... [red]#TO-DO:#  investigate why not the use of the OOTB BusinessRuleTaskHandler directly in RH-PAM based incident-process-kjar implementation.
...  [red]#Requirement for RuleUnit or RuleFlowGroup ?#
.... link:https://github.com/Emergency-Response-Demo/cajun-navy-rules/blob/master/src/main/resources/com.redhat.cajun.navy.rules/IncidentResponderAssignment.drl[IncidentResponderAssignment] technical rules do not have a ruleflow-group associated with them.
.... Subsequently, the following build-time exception is thrown when compiling the business process with a BusinessRuleTask and empty _RuleFlowGroup_ field:
+
-----
Caused by: java.lang.IllegalArgumentException: Rule task "Assign Mission" is invalid: you did not set a unit name, a rule flow group or a decision model
-----

.... Will modify all IncidentResponderAssignment rules to include a RuleFlowGroup



.. Define all outgoing and incoming Kafka topic connectors in:   src/main/resources/application.properties

.. IntermediateThrowEvent:

... Should the _message_ field be populated with the kafka topic name (as defined in application.properties ) ?
+
At authoring time, the previously defined kafka connectors (in application.properties) do not populate drop downs in intermediateThrow and intermediateCatch events of BPMN2.   Are they suppose to ?

... In _travels.bpmn2_, what is _Message_5_Input_ ?

... No *OnEntry Action*
+
Prior to _Incident Un-Assignment Event_, will need to introduce a script task

.. [red]#IntermediateCatchEvent#

... How will auto-generated message consumer grab correlationKey from message ? ie:  link:https://github.com/Emergency-Response-Demo/process-service/blob/master/src/main/java/com/redhat/cajun/navy/process/message/listeners/ResponderUpdatedEventMessageListener.java#L79[ResponderUpdatedEventMessageListener : L79]

... How to filter out irrelevant messages that may be sent to topics that IntermediateCatchEvent is listening on ? ie:  link:https://github.com/Emergency-Response-Demo/process-service/blob/master/src/main/java/com/redhat/cajun/navy/process/message/listeners/ResponderUpdatedEventMessageListener.java#L92-L104[ResponderUpdatedEventMessageListener : 90-104]
+
AMQ Streams / Kafka doesn't support *message selectors* (ie:  similar to Activemq Artemis)

... How will the auto-generated messsage consumer process the incoming message and invoke the correct signal along with the correct corresponding payload ? ie: link:https://github.com/Emergency-Response-Demo/process-service/blob/master/src/main/java/com/redhat/cajun/navy/process/message/listeners/MissionEventTopicListener.java#L97[MissionEventTopicListener : 97]
+
image::images/incident-process-original-with-consumer-topics.png[]





. *15 September 2020*
+
.. New _process-service-quarkus_ project created without issues using the kogito maven archetype as follows:
+
-----
mvn archetype:generate \
        -DinteractiveMode=false \
        -DarchetypeGroupId=org.kie.kogito \
        -DarchetypeArtifactId=kogito-quarkus-archetype \
        -DarchetypeVersion=0.14.0 \
        -DgroupId=com.redhat.cajun.navy \
        -DartifactId=process-service-kogito \
        -Dversion=0.0.1
-----

.. Kogito project to double as kjar
+
In RH-PAM 7 based _process-service_, a separate _incident-process-jar_ (containing the link:https://github.com/Emergency-Response-Demo/incident-process-kjar/blob/master/src/main/resources/com/redhat/cajun/navy/process/incident-process.bpmn[incident-process.bpmn] ) is imported as a dependency.  With Kogito, it's a best practice to version control process and rules artifacts in the same kogito based business service.  Subsequently, _incident-process.bpmn_ was copied to the resources directory of _process-service-kogito_.
+
Original process definition is as follows:
+
image::images/incident-process.png[]

.. [red]#Compilation errors with _process-service-kogito_#
+
... link:https://issues.redhat.com/browse/KOGITO-3353[KOGITO-3353]
... processId renamed from _incident-process_ to the following to allow Kogito to generate Java classes using this processId :   _incidentLifecycle_.

== Kogito related issues and enhancements

- link:https://issues.redhat.com/browse/KOGITO-3161[KOGITO-3161]
- link:https://issues.redhat.com/browse/KOGITO-3353[KOGITO-3353]
- link:https://issues.redhat.com/browse/KOGITO-3681[KOGITO-3681]


